# Сервис спецификаций

Содержит всю спецификацию приложения в стандарте JSONSchema draft-7. Предоставляет методы для добавления элементов
спецификации и выполнения валидации по ней.

### Структура спецификации

Скелет спецификации соответствует формату [OpenAPI 3.0(swagger)](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.3.md),
в котором определена вложенность полей под описание роутеров АПИ, схем моделей и других компонент. Заготовку
спецификации можно определить в конфигурации в опции `default`. Теоретически можно использовать другой скелет, выбор OpenAPI3
обусловлен генерацией документации к АПИ. (OpenAPI 3.0 является подмножеством JSONSchema).

### Определение спецификации

Для расширения скелета спецификации используется метод `spec.set(path, schema)`. Этим методом добавляются любые
части (свойства) спецификации. В спецификацию можно добавлять не только схемы, по которым будет выполняться валидация.
Это также могут быть заготовки (компоненты) для повторного использования, на них можно ссылаться вместо дублирования
описания. Ссылаться по пути, по которому фрагмент спецификации добавлен. Дополнить спефикацию можно и через конфигурацию
сервиса в опции `default`.
   
### Валидация по спецификации

Валидация реализуется методом `spec.validate(path, value)` с использованием библиотеки [ajv](https://github.com/epoberezkin/ajv).
Указывается путь на фрагмент спецификации и значение для валидации. 

### Расширение ключевых слов

Сервис позволяет определить кастомные ключевые слова [JSONSchema](https://github.com/ajv-validator/ajv/blob/master/docs/keywords.md)
вызовом метода `spec.setKeyword(name, options)` или подключив их через файл конфигурации в опции `keywords`.
Ключевым словом задаётся нестандартная логика валидации, которую нельзя (или сложно) описать стандартом JSONSchema. 
Кастомное ключевое слово может использоваться не только для валидации, но и для декларирования логики других сервисов.
Сама логика в таких случаях реализуется не ключевым словом. Другой сервис учитывает наличие ключевого слова и, с учётом его значения,
реализует дополнительную логику. Например, сервис rest-api может учесть ключевое слово session в описании роутера и реализовать
контроль доступа.
   
## Примечание

1. Ссылка (путь) на свойство разделяется символом `/`. Если название свойства содержит этот символ, то его заменяют на два обратных слэша `\\`. 
   Иначе ссылка на свойство будет работать некорректно.
2. Для асинхронной валидации фрагмент схемы должен содержать свойство $async: true. Так как по умолчанию любая валидация
   реализуется асинхронно, то в используемый для валидации фрагмент спецификации автоматически добавляется это свойство.
   Свойство $async учитывается библиотекой ajv

## Пример интеграции

В сервисе для работы с базой данных описываются модели данных в формате JSONSchema. Все схемы моделей добавляются в 
сервис спецификации в `#/components/schema/{model-name}`

```js
spec.set(`#/components/schema/${modelName}`, modelSchema);
```

После чего можно выполнять валидацию объектов по схеме соответствующей модели

```js
const result = spec.validate(`#/components/schema/${modelName}`, object);
```

Описание роутеров express добавляем в `#/paths/{route-url}/{route-method}`. 
В описании роутеров можно ссылаться на схемы моделей по их пути

```js
this.spec.set(`#/paths/\\articles\\{id}/POST`, {
  summary: 'Создание',
  description: 'Создание объекта',
  tags: ['Tests'],
  requestBody: {
    content: {
      'application/json': {schema: {$ref: '#/components/schemas/article'}}
    }
  },
  parameters: [
    {$ref: '#/components/parameters/limit'},
  ],
  responses: {
    200: schemaUtils.success('success', {$ref: '#/components/schemas/article'})
  }
});
```

Всю спецификацию можно выбрать и передать в SwaggerUI для отображения страницы с документацией REST API. 

```js
swaggerUi.setup(spec.getSchemaOpenApi());
```
